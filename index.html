<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Escala de Prejuízos Funcionais</title>
<style>
  :root{
    --bg:#0e1625; --card:#14213b; --line:#2b3f66;
    --text:#f8fafc; --muted:#cbd5e1;
    --pri:#6d28d9; --ok:#10b981; --err:#ef4444; --warn:#f59e0b;
    --chip:#0b1220; --chipHover:#0f1a2e;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);
    font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }
  .wrap{max-width:1024px;margin:20px auto;padding:0 16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:18px}
  h1{margin:0 0 6px;font-size:1.45rem}
  .muted{color:var(--muted)}

  .grid-info{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0 6px}
  @media (max-width:720px){.grid-info{grid-template-columns:1fr}}
  .info{background:rgba(0,0,0,.18);border:1px solid var(--line);border-radius:12px;padding:12px}
  .info b{display:block;margin-bottom:4px;color:#e2e8f0}

  .legend{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 12px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.25);font-size:.86rem}

  /* Seções e itens */
  .section{margin:18px 0 10px}
  .section h2{font-size:1.1rem;margin:0 0 8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.04);border:1px solid var(--line)}
  .item{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;border:1px solid var(--line);border-radius:12px;padding:12px;background:rgba(0,0,0,.18);margin-bottom:10px}
  .stem{font-size:1rem}
  .scale{display:grid;grid-template-columns:repeat(6, minmax(0,1fr));gap:8px;min-width:320px}
  @media (max-width:560px){ .item{grid-template-columns:1fr} .scale{min-width:unset} }

  /* Botões (chips) */
  .optbtn{display:flex;align-items:center;justify-content:center;padding:10px 10px;border:1px solid var(--line);border-radius:10px;background:var(--chip);cursor:pointer;user-select:none;font-weight:600}
  .optbtn:hover{background:var(--chipHover);border-color:#4f70ff}
  .optbtn small{font-weight:400;opacity:.8;margin-left:6px}
  .optbtn input{appearance:none;-webkit-appearance:none;position:absolute;width:0;height:0;opacity:0}
  .optbtn[data-checked="true"]{outline:2px solid #7aa2ff; outline-offset:2px; background:#19233b}

  /* Ações */
  .btn{display:inline-flex;align-items:center;gap:10px;background:var(--pri);border:none;color:#fff;padding:12px 16px;border-radius:12px;cursor:pointer;font-weight:600}
  .btn.ok{background:var(--ok)}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--muted)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Mensagens */
  .msg{margin:12px 0;padding:12px;border-radius:10px}
  .okbox{background:#06351f;border:1px solid #0e6c45;color:#c8ffe3}
  .errbox{background:#3b0d0d;border:1px solid #7f1d1d;color:#ffd5d5}
  .warnbox{background:#3a2903;border:1px solid #885e09;color:#ffe6b0}

  /* Progresso */
  .progress{height:10px;background:rgba(255,255,255,.05);border:1px solid var(--line);border-radius:999px;overflow:hidden}
  .bar{height:100%;width:0%;background:linear-gradient(90deg, #6d28d9, #10b981)}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Escala de Prejuízos Funcionais</h1>
    <p class="muted">
      Marque a opção que melhor indica a <b>frequência</b> com que você vivenciou cada situação nos últimos anos.<br/>
      Opções:<br/>
      <b>NA</b> (Não se aplica, <b>0</b>)<br/>
      <b>N</b> (Nunca, <b>0</b>)<br/>
      <b>R</b> (Raramente, <b>1</b>)<br/>
      <b>AV</b> (Algumas vezes, <b>2</b>)<br/>
      <b>MV</b> (Muitas vezes, <b>3</b>)<br/>
      <b>S</b> (Sempre, <b>4</b>)
    </p>
    <div class="legend">
      <span class="pill">NA = Não se aplica</span>
      <span class="pill">N = Nunca</span>
      <span class="pill">R = Raramente</span>
      <span class="pill">AV = Algumas vezes</span>
      <span class="pill">MV = Muitas vezes</span>
      <span class="pill">S = Sempre</span>
    </div>

    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <div id="progressWrap" style="display:none; gap:8px; align-items:center; margin:8px 0 0;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:6px">
        <span class="muted" id="progressText">Progresso</span>
        <button id="clearDraft" class="btn ghost" type="button" title="Limpar rascunho local">Limpar rascunho</button>
      </div>
      <div class="progress"><div class="bar" id="bar"></div></div>
    </div>

    <form id="form" style="margin-top:14px; display:none;" novalidate>
      <div id="qs"></div>
      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar respostas</button>
        <button id="btnSave" class="btn ghost" type="button" title="Salvar rascunho">Salvar rascunho</button>
      </div>
      <div id="msg" class="msg" style="display:none" role="alert" aria-live="polite"></div>
    </form>

    <div id="alert" class="msg" style="display:none" role="alert" aria-live="assertive"></div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_EPF_ETDAH" };
const CODE = "EPF_ETDAH";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const RELEASE_KEYS = ["EPF_ETDAH"]; // colunas de liberação no Patients

/* ===== HELPERS ===== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent = text;
  el.className = "msg " + (kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display = "block";
}
function hideBox(id){
  const el=$(id);
  if(el){ el.style.display="none"; el.textContent=""; }
}
function maskCPF(cpf){
  const d = onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d] = iso.split("-");
  if(!y||!m||!d) return iso;
  return `${d}/${m}/${y}`;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp = new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  const r = await fetch(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ data:[row] })
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetPatchBy(sheet, column, value, data){
  const r = await fetch(
    `${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`,
    {
      method:"PATCH",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ data })
    }
  );
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
function goPortalWithToken(){
  const TOKEN = qs("token");
  try{
    const u = new URL(PORTAL_URL, location.href);
    u.searchParams.set("token", TOKEN);
    location.href = u.toString();
  }catch(_){
    const sep = PORTAL_URL.includes("?") ? "&" : "?";
    location.href = PORTAL_URL + sep + "token=" + encodeURIComponent(TOKEN);
  }
}

/* ===== ITENS ORGANIZADOS POR ÁREA ===== */
const AREAS = [
  { key:"academica", label:"1) Acadêmica", divisor:8, items:[
    "Meus trabalhos foram de baixa qualidade.",
    "Fui reprovado.",
    "Meus professores e/ou colegas deixaram de confiar em mim.",
    "Fiquei estressado por deixar as tarefas para a última hora.",
    "Deixei cursos inacabados.",
    "Obtive notas baixas.",
    "Gastei mais tempo para concluí-los.",
    "Percebi variações em meu desempenho."
  ]},
  { key:"profissional", label:"2) Profissional", divisor:10, items:[
    "As pessoas ficaram insatisfeitas com o meu desempenho.",
    "Fui repreendido pelo meu superior.",
    "Perdi oportunidades.",
    "Me senti fracassado.",
    "Me senti inseguro.",
    "As pessoas deixaram de confiar em mim.",
    "Fui demitido.",
    "Ocupei cargo abaixo do meu potencial.",
    "A minha carreira ficou parada.",
    "As minhas relações com os colegas de trabalho foram conflituosas."
  ]},
  { key:"afetivo_sexual", label:"3) Afetivo-sexual", divisor:8, items:[
    "O meu parceiro precisou assumir responsabilidades que eram minhas.",
    "Os términos foram precipitados.",
    "Recebi queixas sobre o meu modo de ser.",
    "Vivenciei conflitos com o meu companheiro.",
    "Pequenos desentendimentos ganharam uma grande proporção.",
    "Meu parceiro ficou insatisfeito comigo.",
    "Senti-me entediado.",
    "Tive dificuldade em manter relações duradouras."
  ]},
  { key:"domestica", label:"4) Doméstica", divisor:7, items:[
    "Os ambientes ficaram bagunçados por um grande período de tempo.",
    "Meus familiares ficaram chateados pelo meu modo de ser.",
    "Ocorreram pequenos acidentes (por exemplo, esqueci a panela no fogo, me cortei).",
    "Senti-me incapaz para realizar os afazeres domésticos.",
    "Vivenciei conflitos com meus familiares.",
    "Perdi o prazo de garantia de eletrodomésticos que precisavam de troca ou reparo.",
    "Fui chamado de irresponsável."
  ]},
  { key:"social", label:"5) Social", divisor:9, items:[
    "As pessoas se afastaram de mim.",
    "Me senti inseguro.",
    "Fui chamado de enrolado.",
    "Fui considerado inconveniente.",
    "Tive dificuldade em manter amizades duradouras.",
    "Passei uma impressão de descaso.",
    "Vivenciei conflitos com as pessoas.",
    "As pessoas ficaram chateadas comigo.",
    "Fui considerado antipático."
  ]},
  { key:"financeira", label:"6) Financeira", divisor:7, items:[
    "Tive gastos desnecessários.",
    "Fiquei endividado.",
    "Tive algum serviço cortado/suspenso por falta de pagamento.",
    "Dependi de alguém para controlar minhas finanças.",
    "Tive prejuízos financeiros.",
    "Tive restrição de crédito.",
    "Tive meu nome incluído em algum cadastro (SERASA, SPC) em função de dívidas."
  ]},
  { key:"saude", label:"7) Saúde", divisor:6, items:[
    "Tive horários de alimentação desregulados.",
    "Adoeci por falta de prevenção.",
    "A minha rotina de sono foi alterada.",
    "Fiquei sedentário.",
    "Tive doenças agravadas por falta de cuidado.",
    "Tive problemas com álcool, cigarro e/ou drogas."
  ]},
  { key:"transito", label:"8) Trânsito", divisor:6, items:[
    "As pessoas se sentiram inseguras em andar comigo enquanto eu dirigia o carro.",
    "Me envolvi em acidentes.",
    "Recebi multas de trânsito.",
    "Coloquei-me em situações de risco.",
    "Me envolvi em conflitos com outros motoristas quando dirigia meu carro.",
    "Meu veículo ficou exposto a danos e desgastes mecânicos."
  ]},
  { key:"risco_legal", label:"9) Risco legal", divisor:5, items:[
    "Vivenciei momentos difíceis por desacatar figuras de autoridade (como policiais, professores e/ou chefe).",
    "Me envolvi em situações graves em que poderia ter sido preso.",
    "Me expus a situações perigosas por fazer uso e/ou transportar substâncias ilícitas.",
    "Corri o risco de ser processado por constranger, insultar e/ou humilhar outra pessoa.",
    "Corri o risco de ser processado por agredir outra pessoa."
  ]}
];

// mapeamento dos índices das questões por área (preenchido no render)
const AREA_INDEX = {};

/* ===== OPÇÕES (NA, N, R, AV, MV, S) ===== */
const CHOICES = [
  {abbr:"NA", label:"Não se aplica",  value:0},
  {abbr:"N",  label:"Nunca",          value:0},
  {abbr:"R",  label:"Raramente",      value:1},
  {abbr:"AV", label:"Algumas vezes",  value:2},
  {abbr:"MV", label:"Muitas vezes",   value:3},
  {abbr:"S",  label:"Sempre",         value:4},
];

/* lista achatada para guardar meta de cada questão */
let FLAT_ITEMS = []; // [{n, areaKey, areaLabel, text}, ...]

// total de perguntas
const TOTAL_QTD = AREAS.reduce((s,a)=> s + a.items.length, 0);

/* ===== ESTADO ===== */
let patient=null, tokenRow=null, CPF="";
const TOKEN = qs("token");
const STORAGE_KEY = `PREJ_${TOKEN||'anon'}`;
let startAt = Date.now();

/* ===== RENDER ===== */
function renderQuestions(){
  const host = $("#qs"); host.innerHTML = "";
  let qCount = 0;
  FLAT_ITEMS = [];

  AREAS.forEach(area=>{
    const sec = document.createElement("div");
    sec.className = "section";
    sec.innerHTML = `<h2>${area.label}</h2>`;
    host.appendChild(sec);

    AREA_INDEX[area.key] = [];

    area.items.forEach((text)=>{
      qCount++;
      const qn = String(qCount).padStart(2,"0");
      AREA_INDEX[area.key].push(qCount);
      FLAT_ITEMS.push({
        n: qCount,
        areaKey: area.key,
        areaLabel: area.label,
        text
      });

      const row = document.createElement("div");
      row.className = "item";
      row.setAttribute("data-q", String(qCount));

      const stem = document.createElement("div");
      stem.className = "stem";
      stem.id = `s${qn}`;
      stem.textContent = `${qCount}. ${text}`;

      const scale = document.createElement("div");
      scale.className = "scale";

      CHOICES.forEach((c,idx)=>{
        const id = `q${qn}_${idx}`;
        const lab = document.createElement("label");
        lab.className = "optbtn";
        lab.setAttribute("title", `${c.abbr} — ${c.label} (${c.value})`);
        lab.innerHTML = `
          <input type="radio" name="q${qn}" id="${id}" value="${c.value}" required aria-labelledby="s${qn}">
          <span>${c.abbr}<small>${c.value}</small></span>`;
        scale.appendChild(lab);
      });

      row.append(stem, scale);
      host.appendChild(row);
    });
  });

  // progress inicial
  $("#progressText").textContent = `Progresso: 0/${qCount}`;
}

/* ===== BOOT ===== */
(async function boot(){
  try{
    if(!TOKEN){
      setBox("#alert","Link inválido (sem token). Solicite um novo link.","err");
      return;
    }

    const trows = await sheetSearch(SHEETS.TOKENS, { token: TOKEN });
    if(!trows || !trows.length) throw new Error("Token inválido ou expirado.");
    tokenRow = trows[0];
    if(String(tokenRow.disabled||"não").toLowerCase()==="sim") throw new Error("Token desativado. Peça um novo link.");
    if(tokenRow.expires_at && new Date(tokenRow.expires_at) < new Date()) throw new Error("Token expirado. Peça um novo link.");
    CPF = onlyDigits(tokenRow.cpf||"");
    if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows = await sheetSearch(SHEETS.PATIENTS, { cpf: CPF });
    if(!prows || !prows.length) throw new Error("Paciente não encontrado.");
    patient = prows[0];

    const isAllowed = RELEASE_KEYS.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    if(!isAllowed){
      setBox("#alert","Este formulário não está liberado para você.","err");
      return;
    }

    renderPatientInfo();
    renderQuestions();

    // já respondeu?
    const doneKeys = RELEASE_KEYS.map(k => `${k}_FEITO`);
    const anyDoneFlag = doneKeys.some(k => String(patient[k]||"").trim().toLowerCase()==="sim");
    const already = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(anyDoneFlag || (already && already.length)){
      setBox("#alert","Você já respondeu este formulário. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken, 1200);
      return;
    }

    restoreDraft();
    updateProgress();

    $("#pacInfo").style.display = "grid";
    $("#form").style.display = "block";
    $("#progressWrap").style.display = "block";
    hideBox("#alert");

    // highlight visual dos chips ao marcar
    document.addEventListener("change",(e)=>{
      if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
        const name = e.target.name;
        $$(`label.optbtn`).forEach(lab=>{
          const input = lab.querySelector("input");
          if (input && input.name === name){
            lab.dataset.checked = input.checked ? "true" : "false";
          }
        });
      }
    });

    startAt = Date.now();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formulário. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g = $("#pacInfo"); g.innerHTML="";
  const info = [
    ["Nome", patient.nome || "-"],
    ["CPF", maskCPF(patient.cpf)],
   
  ];
  for(const [k,v] of info){
    const div = document.createElement("div");
    div.className = "info";
    div.innerHTML = `<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(div);
  }
}

/* ===== RASCUNHO LOCAL ===== */
function saveDraft(){
  const data = {};
  for(let i=1;i<=TOTAL_QTD;i++){
    const qn = String(i).padStart(2,"0");
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    if(sel) data[`q${qn}`] = Number(sel.value);
  }
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }catch(e){
    console.warn("Sem espaço para salvar rascunho");
  }
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    for(const [k,v] of Object.entries(data||{})){
      const el = document.querySelector(`input[name="${k}"][value="${v}"]`);
      if(el){
        el.checked = true;
        const lab = el.closest("label.optbtn");
        if(lab) lab.dataset.checked="true";
      }
    }
  }catch(e){
    /* ignore */
  }
}
function clearDraft(){
  localStorage.removeItem(STORAGE_KEY);
}

function countAnswered(){
  let c=0;
  for(let i=1;i<=TOTAL_QTD;i++){
    const qn=String(i).padStart(2,'0');
    if(document.querySelector(`input[name="q${qn}"]:checked`)) c++;
  }
  return c;
}
function updateProgress(){
  const answered = countAnswered();
  $("#progressText").textContent = `Progresso: ${answered}/${TOTAL_QTD}`;
  $("#bar").style.width = `${(answered/TOTAL_QTD)*100}%`;
}

/* ===== EVENTOS DE UI ===== */
addEventListener('change', (e)=>{
  if(e.target && e.target.matches('input[type="radio"][name^="q"]')){
    saveDraft();
    updateProgress();
  }
});
$("#btnSave").addEventListener('click', ()=>{
  saveDraft();
  setBox('#msg','Rascunho salvo neste dispositivo.','ok');
});
$("#clearDraft").addEventListener('click', ()=>{
  clearDraft();
  setBox('#msg','Rascunho apagado.','warn');
});

/* ===== CÁLCULOS ===== */
function sumArea(key){
  const idxs = AREA_INDEX[key] || [];
  let s = 0;
  for(const i of idxs){
    const qn = String(i).padStart(2,'0');
    const sel = document.querySelector(`input[name="q${qn}"]:checked`);
    s += sel ? Number(sel.value) : 0;
  }
  return s;
}

/* ===== SUBMIT ===== */
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return;
  sending = true;
  hideBox("#msg");

  const btn = $("#btnSubmit");
  const originalText = btn.textContent;
  btn.disabled = true;
  btn.textContent = "Enviando…";

  try{
    if(!patient) throw new Error("Sessão inválida. Recarregue o link.");

    // 1. validação: todas respondidas
    for(let i=1;i<=TOTAL_QTD;i++){
      const qn = String(i).padStart(2,'0');
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      if(!sel){
        const row = document.querySelector(`.item[data-q="${i}"]`);
        if(row) row.scrollIntoView({behavior:'smooth', block:'center'});
        throw new Error(`Responda a questão ${i}.`);
      }
    }

    // 2. Anti-duplicidade antes de gravar
    const again = await sheetSearch(SHEETS.SCORES, { cpf: CPF, code: CODE });
    if(again && again.length){
      setBox("#msg","Este formulário já foi enviado anteriormente. Voltando ao portal…","ok");
      setTimeout(goPortalWithToken,1000);
      return;
    }

    // 3. Coleta respostas + lista por questão
    const qaList = [];      // [{n, area, area_label, q, abbr, label, value}]
    const answersMap = {};  // { q01: 2, q02: 0, ... }

    for(let i=1;i<=TOTAL_QTD;i++){
      const qn = String(i).padStart(2,"0");
      const sel = document.querySelector(`input[name="q${qn}"]:checked`);
      const rawVal = Number(sel.value);

      // descobrir qual opção (NA, N, etc.)
      // id tem formato q01_0, q01_1...
      const parts = sel.id.split("_");
      const choiceIdx = Number(parts[1]||0);
      const choiceInfo = CHOICES[choiceIdx] || {abbr:"",label:"",value:rawVal};

      const meta = FLAT_ITEMS[i-1] || {areaKey:"",areaLabel:"",text:""};

      qaList.push({
        n: i,
        area: meta.areaKey,
        area_label: meta.areaLabel,
        q: meta.text,
        abbr: choiceInfo.abbr,
        label: choiceInfo.label,
        value: rawVal
      });

      answersMap[`q${qn}`] = rawVal;
    }

    // 4. Somas e médias por área
    const results = {}; // {academica:{soma,media}, ...}
    AREAS.forEach(a=>{
      const soma = sumArea(a.key);
      const media = soma / a.divisor;
      results[a.key] = { soma, media };
    });

    // total bruto geral
    const totalBruto = Object.values(results).reduce((s,a)=> s + a.soma, 0);

    // CSV com médias por área pra coluna categoria
    const categoria_csv = AREAS
      .map(a=> `${a.key}=${(results[a.key].media).toFixed(2)}`)
      .join(',');

    // duração
    const durationSec = Math.round((Date.now()-startAt)/1000);

    // 5. Salva linha na planilha
    await sheetCreate(SHEETS.SCORES, {
      result_id: `${patient.cpf}_${CODE}_${Date.now()}`,
      token: TOKEN,
      cpf: patient.cpf,
      code: CODE,
      source: "paciente",
      submitted_at: new Date().toISOString(),
      total: totalBruto,
      categoria: categoria_csv,
      metrics: "",
      questions: JSON.stringify(qaList),
      
    });

    // 6. Marca como feito
    const doneUpdates = {};
    RELEASE_KEYS.map(k=>`${k}_FEITO`).forEach(k=>{
      if(k in patient) doneUpdates[k] = "sim";
    });
    if(Object.keys(doneUpdates).length===0){
      doneUpdates[`${RELEASE_KEYS[0]}_FEITO`] = "sim";
    }
    await sheetPatchBy(SHEETS.PATIENTS, "cpf", patient.cpf, doneUpdates);

    clearDraft();
    setBox("#msg","Formulário enviado. Voltando ao portal…","ok");
    setTimeout(goPortalWithToken, 1100);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending = false;
    btn.disabled = false;
    btn.textContent = originalText;
  }
});
</script>
</body>
</html>
